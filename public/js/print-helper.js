
const escapeHtml = (unsafe) => {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
};


function generateAndPrint(data, page = 1, perPage = 10, companyName = 'My Company', authUserName = 'Guest') {


    if (!Array.isArray(data) || data.length === 0) {
        console.error("No data available to print.");
        alert("No data available to print.");
        return;
    }


    const tableRows = data.map((supplier, index) => {
        const rowNumber = (page - 1) * perPage + (index + 1);


        const name = escapeHtml(supplier.name);
        const email = escapeHtml(supplier.email);
        const phone = supplier.phone ? escapeHtml(supplier.phone) : '-';
        const address = escapeHtml(supplier.address);

        return `
            <tr>
                <td>${rowNumber}</td>
                <td>${name}</td>
                <td>${email}</td>
                <td class="text-center">${phone}</td>
                <td>${address}</td>
            </tr>
        `;
    }).join('');


    const printContent = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Supplier Report - ${escapeHtml(companyName)}</title>
            <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>
            <style>
                /* A4 Page Settings */
                @page {
                    size: A4;
                    margin: 10mm 15mm 15mm 15mm;

                    @bottom-left {
                        content: "Powered by: ${escapeHtml(companyName)}";
                        font-size: 9pt;
                        color: #888;
                    }
                    @bottom-center {
                        content: "Generated by: ${escapeHtml(authUserName)}";
                        font-size: 9pt;
                        color: #888;
                    }
                    @bottom-right {
                        content: "Page " counter(page) " of " counter(pages);
                        font-size: 9pt;
                        color: #888;
                    }
                }

                /* General Styles */
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 12pt;
                    color: #333;
                }

                /* Header Styles */
                .header-container { margin-bottom: 20px; border-bottom: 2px solid #444; padding-bottom: 10px; }
                h1 { text-align: center; margin: 0; font-size: 22pt; text-transform: uppercase; letter-spacing: 1px; }
                .meta-info { display: flex; justify-content: space-between; margin-top: 10px; font-size: 10pt; color: #555; }

                /* Table Styles */
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 10pt; vertical-align: top; }
                th { background-color: #f4f4f4; font-weight: bold; color: #000; text-transform: uppercase; font-size: 9pt; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                tr { break-inside: avoid; }

                .text-center { text-align: center; }
            </style>
        </head>
        <body>
            <div class="header-container">
                <h1>Supplier Management Report</h1>
                <div class="meta-info">
                    <span>Company: ${escapeHtml(companyName)}</span>
                    <span>Printed on: ${new Date().toLocaleString()}</span>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 20%;">Name</th>
                        <th style="width: 25%;">Email</th>
                        <th style="width: 15%;">Phone</th>
                        <th style="width: 35%;">Address</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>

            <script>
                // PagedJS Handler for Auto Print
                class PrintingHandler extends Paged.Handler {
                    constructor(chunker, polisher, caller) { super(chunker, polisher, caller); }
                    afterPreview(pages) {
                        setTimeout(() => {
                            window.print();

                        }, 1000);
                    }
                }
                Paged.registerHandlers(PrintingHandler);
            </script>
        </body>
        </html>
    `;


    const IFRAME_ID = 'print-iframe-report';
    let iframe = document.getElementById(IFRAME_ID);

    if (iframe) {
        document.body.removeChild(iframe);
    }

    iframe = document.createElement('iframe');
    iframe.id = IFRAME_ID;


    Object.assign(iframe.style, {
        position: 'fixed',
        right: '0',
        bottom: '0',
        width: '0',
        height: '0',
        border: '0',
        visibility: 'hidden'
    });

    document.body.appendChild(iframe);


    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(printContent);
    doc.close();
}
